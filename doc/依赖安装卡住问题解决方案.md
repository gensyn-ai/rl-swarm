# 依赖安装卡住问题解决方案

## 问题描述

在 Mac Mini M4 上运行 `./run_rl_swarm_mac.sh` 时，在 "Installing CPU-only dependencies with Apple Silicon optimizations..." 步骤卡住。

## 立即解决方案

### 方法一：使用修复脚本（推荐）

我已经为你创建了一个专门的修复脚本：

```bash
# 首先停止当前卡住的进程（按 Ctrl+C）
# 然后运行修复脚本
./fix_mac_dependencies.sh
```

这个脚本会：
1. ✅ 清理现有的虚拟环境
2. ✅ 设置 Apple Silicon 优化环境
3. ✅ 分步安装依赖，避免一次性安装导致的问题
4. ✅ 特别处理 `hivemind` 包（最容易出问题的包）
5. ✅ 验证所有关键依赖是否正确安装

### 方法二：手动清理重试

如果修复脚本不能解决问题，可以手动清理：

```bash
# 1. 停止当前进程（Ctrl+C）
# 2. 清理环境
rm -rf .venv
uv cache clean

# 3. 重新运行优化版脚本
./run_rl_swarm_mac.sh
```

## 问题原因分析

### 主要原因

1. **Hivemind 包编译问题**
   - `hivemind` 需要从 Git 克隆并编译
   - 在 Apple Silicon 上编译可能遇到兼容性问题
   - 网络超时可能导致下载失败

2. **依赖冲突**
   - 某些包在 Apple Silicon 上需要特定版本
   - `torch` 需要使用 CPU 版本的特定索引

3. **内存或网络问题**
   - 同时安装太多包可能导致内存不足
   - 网络不稳定导致下载超时

### 优化后的解决方案特点

✅ **分步安装**：先安装基础包，再安装复杂的包  
✅ **容错机制**：如果某个包安装失败，尝试替代方案  
✅ **Apple Silicon 优化**：针对 M4 芯片设置最佳编译环境  
✅ **超时控制**：为每个安装步骤设置合理超时  
✅ **验证机制**：安装后验证所有关键依赖  

## 如果还是有问题

### 检查网络连接

```bash
# 测试网络连接
ping -c 3 github.com
ping -c 3 pypi.org
```

### 检查系统要求

```bash
# 检查 Xcode Command Line Tools
xcode-select -p

# 如果没有安装，运行：
xcode-select --install
```

### 手动安装关键依赖

```bash
# 创建虚拟环境
uv venv --python 3.11

# 手动安装核心包
uv run pip install torch --index-url https://download.pytorch.org/whl/cpu
uv run pip install transformers>=4.46.0
uv run pip install datasets
uv run pip install trl

# 最后安装 hivemind
uv run pip install "git+https://github.com/learning-at-home/hivemind@1.11.11" --timeout=900
```

## 预防措施

1. **确保网络稳定**：使用有线网络或稳定的 WiFi
2. **关闭其他应用**：释放内存和 CPU 资源
3. **检查磁盘空间**：确保至少有 10GB 可用空间
4. **保持设备凉爽**：避免 CPU 过热降频

## 成功标志

修复成功后，你应该能看到：

```
>> 🎉 关键依赖安装成功！现在可以运行 RL-Swarm 了
>> 运行命令: ./run_rl_swarm_mac.sh
```

然后就可以正常使用优化版的 RL-Swarm 了！

## 支持

如果以上方法都不能解决问题，可能需要：

1. 检查 macOS 版本兼容性
2. 更新 Homebrew 和相关工具
3. 考虑使用 Docker 环境（如果问题持续存在）

记住：Mac Mini M4 是很强大的设备，这些依赖问题是可以解决的！💪 