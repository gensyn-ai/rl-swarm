# 节点可见性问题诊断指南

## 问题描述

当您登录 [Gensyn Math-Hard 仪表板](https://dashboard-math-hard.gensyn.ai/) 时，在"YOUR NODES"部分显示"NO NODES FOUND"，即使您的节点正在运行。

## 快速诊断

运行自动诊断工具：

```bash
./ops/scripts/diagnose_node_visibility.sh
```

## 常见原因及解决方案

### 1. 🔐 身份认证问题

**症状**: ORG_ID 缺失或API密钥未激活

**解决方案**:
```bash
# 重新运行登录流程
./manage.sh

# 检查邮箱确认邮件
# 激活API密钥
```

### 2. 📝 节点注册失败

**症状**: 日志中没有"Registering self with peer ID"信息

**检查方法**:
```bash
grep -r "Registering self with peer ID" logs/
```

**解决方案**:
```bash
# 删除旧的节点身份文件
rm -f swarm.pem

# 重新启动节点
./manage.sh
```

### 3. ⏰ 时间延迟问题

**症状**: 节点刚启动不久

**说明**: 
- 节点注册到显示在仪表板通常需要 **2-5分钟**
- 排行榜只显示有奖励记录的活跃节点
- 需要完成至少一轮训练才会被收录

### 4. 🏃‍♂️ 节点性能问题

**症状**: 节点被跳过轮次

**原因**: 
- 设备性能不足，无法跟上训练节奏
- 网络连接不稳定

**解决方案**:
- 使用性能更好的设备
- 优化网络连接
- 调整配置参数

### 5. 🌐 网络连接问题

**检查连接**:
```bash
# 测试Gensyn测试网连接
curl -s "https://gensyn-testnet.g.alchemy.com/public"

# 测试仪表板连接  
curl -s "https://dashboard-math-hard.gensyn.ai/"
```

### 6. 🐛 TRL库Bug问题

**症状**: 出现 `UnboundLocalError: cannot access local variable 'reward_model'` 错误

**原因**: TRL库中的已知bug，`reward_model`变量未正确初始化

**解决方案**:
```bash
# 运行修复脚本
python3 ops/fixes/fix_trl_reward_model_bug.py

# 重新启动节点
./manage.sh
```

### 7. 🎭 昵称匹配问题

**重要提醒**: 仪表板显示的是**动物昵称**，不是Peer ID

**检查您的动物昵称**:
```bash
# 在日志中查找昵称
grep "Hello" logs/*.log

# 示例输出: 🐱 Hello 🐈 [PEACEFUL HAIRY DOG] 🦮 [QmXxx...]
```

## 详细检查步骤

### 步骤 1: 验证身份配置

```bash
# 检查用户数据文件
cat modal-login/temp-data/userData.json

# 获取ORG_ID
ORG_ID=$(awk 'BEGIN { FS = "\"" } !/^[ \t]*[{}]/ { print $(NF - 1); exit }' modal-login/temp-data/userData.json)
echo "ORG_ID: $ORG_ID"

# 检查API密钥状态
curl -s "http://localhost:3000/api/get-api-key-status?orgId=$ORG_ID"
```

### 步骤 2: 验证节点状态

```bash
# 检查节点进程
ps aux | grep train_single_gpu

# 检查节点身份
python3 -c "
import hivemind
dht = hivemind.DHT(start=False, identity_path='swarm.pem')
print('Peer ID:', str(dht.peer_id))
"
```

### 步骤 3: 检查链上注册

访问区块链浏览器查看注册交易：
- [Gensyn Testnet Explorer](https://gensyn-testnet.explorer.alchemy.com/address/0x2fC68a233EF9E9509f034DD551FF90A79a0B8F82?tab=logs)

查找包含您Peer ID的`RegisterPeer`事件。

### 步骤 4: 监控实时状态

```bash
# 查看实时日志
tail -f logs/*.log

# 使用内置监控系统
./ops_full_manager.sh

# 访问本地Web界面 (如果可用)
open http://localhost:3000
```

## 多节点部署注意事项

### 相同邮箱多节点

**✅ 支持的配置**:
- 同一邮箱可以注册多个节点
- 每个节点有独立的Peer ID
- 每个节点独立获得奖励

**⚠️ 潜在限制**:
- 相同IP的节点可能被降权
- 建议使用不同IP地址部署

### 最佳实践

1. **分布式部署**: 使用不同IP地址
2. **独立身份**: 每个节点使用独立的`swarm.pem`
3. **性能监控**: 确保每个节点都能跟上训练节奏
4. **日志分离**: 为每个节点配置独立的日志目录

## 故障排除清单

- [ ] ORG_ID 已正确设置
- [ ] API密钥已激活
- [ ] `swarm.pem` 文件存在且有效
- [ ] **TRL库bug已修复** (重要!)
- [ ] 节点进程正在运行
- [ ] 日志显示注册成功
- [ ] 网络连接正常
- [ ] 等待足够时间 (5-10分钟)
- [ ] 在仪表板上搜索动物昵称而非Peer ID

## 联系支持

如果按照上述步骤仍无法解决问题，请提供以下信息：

1. 诊断脚本输出结果
2. 节点运行日志 (`logs/*.log`)
3. 网络环境描述 (IP地址、地理位置等)
4. 设备配置信息

---

*💡 提示: 大多数可见性问题都是由于时间延迟或身份认证问题导致的，请耐心等待并检查登录状态。* 